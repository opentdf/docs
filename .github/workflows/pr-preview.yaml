name: Deploy PR Preview

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'docs/**'
      - 'blog/**'
      - 'src/**'
      - 'static/**'
      - 'code_samples/**'
      - 'specs/**'
      - 'specs-processed/**'
      - 'docusaurus.config.ts'
      - 'docusaurus-lib-list-remote.js'
      - 'openapi-generated-clients.ts'
      - 'sidebars.js'
      - 'package.json'
      - 'package-lock.json'
      - 'babel.config.js'
      - 'tsconfig.json'
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to deploy preview for'
        required: true
        type: number

jobs:
  deploy-preview:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Get PR number
        id: pr
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "number=${{ inputs.pr_number }}" >> $GITHUB_OUTPUT
          else
            echo "number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          fi

      - name: Checkout gh-pages to get existing mapping
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages-check

      - name: Generate or retrieve preview ID
        id: preview_id
        run: |
          PR_NUMBER=${{ steps.pr.outputs.number }}
          MAPPING_FILE="gh-pages-check/.pr-mappings.json"

          # Create mapping file if it doesn't exist
          if [ ! -f "$MAPPING_FILE" ]; then
            echo "{}" > "$MAPPING_FILE"
          fi

          # Check if this PR already has a preview ID
          EXISTING_ID=$(jq -r --arg pr "$PR_NUMBER" '.[$pr] // empty' "$MAPPING_FILE")

          if [ -n "$EXISTING_ID" ]; then
            # Reuse existing ID
            echo "id=${EXISTING_ID}" >> $GITHUB_OUTPUT
            echo "Reusing existing preview ID: ${EXISTING_ID}"
          else
            # Generate new random 8-character hex ID
            NEW_ID=$(openssl rand -hex 4)
            echo "id=${NEW_ID}" >> $GITHUB_OUTPUT
            echo "Generated new preview ID: ${NEW_ID}"
          fi

          # Clean up the check directory
          rm -rf gh-pages-check

      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_dispatch' && format('refs/pull/{0}/head', inputs.pr_number) || github.ref }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build website with base URL
        run: npm run build
        env:
          BASE_URL: /preview-${{ steps.preview_id.outputs.id }}/

      - name: Remove CNAME file from build (conflicts with subdirectory deployment)
        run: rm -f build/CNAME

      - name: Checkout gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          path: gh-pages

      - name: Deploy to preview subdirectory
        run: |
          PR_NUMBER=${{ steps.pr.outputs.number }}
          PREVIEW_ID=${{ steps.preview_id.outputs.id }}
          PREVIEW_DIR="preview-${PREVIEW_ID}"

          # Create preview directory if it doesn't exist
          mkdir -p "gh-pages/${PREVIEW_DIR}"

          # Remove old content and copy new build
          rm -rf "gh-pages/${PREVIEW_DIR}"/*
          cp -r build/* "gh-pages/${PREVIEW_DIR}/"

          # Update mapping file
          cd gh-pages
          if [ ! -f ".pr-mappings.json" ]; then
            echo "{}" > .pr-mappings.json
          fi
          jq --arg pr "$PR_NUMBER" --arg id "$PREVIEW_ID" '.[$pr] = $id' .pr-mappings.json > .pr-mappings.json.tmp
          mv .pr-mappings.json.tmp .pr-mappings.json

          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Commit and push
          git add .
          git commit -m "Deploy preview for PR #${PR_NUMBER} (${PREVIEW_DIR})" || echo "No changes to commit"
          git push origin gh-pages

      - name: Comment PR with preview URL
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.pr.outputs.number }};
            const previewId = '${{ steps.preview_id.outputs.id }}';
            const repo = context.repo;

            // Get the GitHub Pages URL (handles custom domains)
            let pagesUrl = 'opentdf.io'; // Custom CNAME configured for this repo
            const previewUrl = `https://${pagesUrl}/preview-${previewId}/`;

            // Find existing preview comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: repo.owner,
              repo: repo.repo,
              issue_number: prNumber,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('Preview deployment')
            );

            const commentBody = `## ðŸš€ Preview deployment

            Your preview is ready!

            **Preview URL:** ${previewUrl}

            *Updated: ${new Date().toUTCString()}*`;

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: repo.owner,
                repo: repo.repo,
                comment_id: botComment.id,
                body: commentBody,
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: repo.owner,
                repo: repo.repo,
                issue_number: prNumber,
                body: commentBody,
              });
            }
