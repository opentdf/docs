name: Docker Compose Stack Test

on:
  push:
    branches: [ main ]
    paths:
      - 'static/quickstart/**'
      - 'tests/**'
      - '.github/workflows/docker-compose-test.yml'
      - 'docs/getting-started/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'static/quickstart/**'
      - 'tests/**'
      - '.github/workflows/docker-compose-test.yml'
      - 'docs/getting-started/**'
  workflow_dispatch:

jobs:
  test-quickstart-scripts:
    runs-on: ${{ matrix.os }}
    timeout-minutes: 10
    name: Test quickstart scripts on ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install BATS and shellcheck (Ubuntu)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y bats shellcheck

      - name: Install BATS and shellcheck (macOS)
        if: runner.os == 'macOS'
        run: |
          brew install bats-core shellcheck

      - name: Install shellcheck (Windows)
        if: runner.os == 'Windows'
        run: |
          choco install shellcheck -y

      - name: Install BATS via npm (Windows)
        if: runner.os == 'Windows'
        run: |
          npm install -g bats

      - name: Run BATS tests (Linux - full suite)
        if: runner.os == 'Linux'
        run: |
          bats tests/quickstart.bats

      - name: Run BATS tests (macOS - non-Docker tests)
        if: runner.os == 'macOS'
        shell: bash
        run: |
          # Run only non-Docker tests on macOS
          bats tests/quickstart.bats --filter "shellcheck"
          bats tests/quickstart.bats --filter "bash syntax"
          bats tests/quickstart.bats --filter "port validation"
          bats tests/quickstart.bats --filter "defines.*function"
          bats tests/quickstart.bats --filter "properly quotes"
          bats tests/quickstart.bats --filter "properly declares"
          bats tests/quickstart.bats --filter "detect platform"
          bats tests/quickstart.bats --filter "readable output"
          bats tests/quickstart.bats --filter "color codes"

      - name: Run BATS tests (Windows - non-Docker tests)
        if: runner.os == 'Windows'
        shell: bash
        run: |
          # Run only non-Docker tests on Windows
          bats tests/quickstart.bats --filter "shellcheck"
          bats tests/quickstart.bats --filter "bash syntax"
          bats tests/quickstart.bats --filter "port validation"
          bats tests/quickstart.bats --filter "defines.*function"
          bats tests/quickstart.bats --filter "properly quotes"
          bats tests/quickstart.bats --filter "properly declares"
          bats tests/quickstart.bats --filter "detect platform"
          bats tests/quickstart.bats --filter "readable output"
          bats tests/quickstart.bats --filter "color codes"

      - name: Test check.sh execution (macOS and Windows)
        if: runner.os != 'Linux'
        shell: bash
        run: |
          # Test that check.sh can execute and handle missing Docker gracefully
          echo "Testing check.sh on ${{ runner.os }}..."
          bash static/quickstart/check.sh || true
          echo "check.sh execution test completed"

      - name: Test install.sh OS detection (macOS and Windows)
        if: runner.os != 'Linux'
        shell: bash
        run: |
          # Source the script and test OS detection function
          echo "Testing install.sh OS detection on ${{ runner.os }}..."
          bash -c 'source static/quickstart/install.sh && detect_os_and_arch' || echo "OS detection tested"

  test-stack:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: test-quickstart-scripts

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Shellcheck quickstart scripts
        run: |
          sudo apt-get update
          sudo apt-get install -y shellcheck
          shellcheck static/quickstart/check.sh
          shellcheck static/quickstart/install.sh

      - name: Add hosts entries
        run: |
          echo -e "127.0.0.1 platform.opentdf.local\n127.0.0.1 keycloak.opentdf.local" | sudo tee -a /etc/hosts
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Setup Docker's apt repository
        run: | 
            # Add Docker's official GPG key:
            sudo apt update
            sudo apt install ca-certificates curl
            sudo install -m 0755 -d /etc/apt/keyrings
            sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
            sudo chmod a+r /etc/apt/keyrings/docker.asc

            # Add the repository to Apt sources:
            sudo tee /etc/apt/sources.list.d/docker.sources <<EOF
            Types: deb
            URIs: https://download.docker.com/linux/ubuntu
            Suites: $(. /etc/os-release && echo "${UBUNTU_CODENAME:-$VERSION_CODENAME}")
            Components: stable
            Signed-By: /etc/apt/keyrings/docker.asc
            EOF

            sudo apt update

      - name: Install Docker Compose
        run: |
          sudo apt-get update
          sudo apt-get install -y docker-compose-plugin
          docker compose version
      
      - name: Start Docker Compose stack
        working-directory: docs/getting-started
        run: |
          docker compose up -d
      
      - name: Wait for platform health check
        run: |
          echo "Waiting for platform to be ready..."
          timeout=300  # 5 minutes in seconds
          elapsed=0
          interval=15
          
          while [ $elapsed -lt $timeout ]; do
            echo "Checking health endpoint (${elapsed}s elapsed)..."
            
            # Use -k to allow insecure connections (self-signed cert)
            # Use -s for silent mode, -w for response code
            response=$(curl -k -s -w "\n%{http_code}" https://platform.opentdf.local:8443/healthz 2>/dev/null || echo "")
            
            if [ -n "$response" ]; then
              http_code=$(echo "$response" | tail -n1)
              body=$(echo "$response" | head -n1)
              
              echo "HTTP Code: $http_code"
              echo "Response Body: $body"
              
              if [ "$http_code" = "200" ] && echo "$body" | grep -q '"status":"SERVING"'; then
                echo "✓ Platform is ready!"
                exit 0
              fi
            fi
            
            sleep $interval
            elapsed=$((elapsed + interval))
          done
          
          echo "✗ Timeout waiting for platform to become ready"
          exit 1
      
      - name: Show container logs on failure
        if: failure()
        working-directory: docs/getting-started
        run: |
          docker compose ps
          docker compose logs
